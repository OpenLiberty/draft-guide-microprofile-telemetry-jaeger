//  Copyright (c) 2023 IBM Corporation and others.
// Licensed under Creative Commons Attribution-NoDerivatives
// 4.0 International (CC BY-ND 4.0)
//   https://creativecommons.org/licenses/by-nd/4.0/
//
// Contributors:
//     IBM Corporation
//
:page-layout: guide-multipane
:projectid: microprofile-telemetry-jaeger
:page-duration: 20 minutes
:page-releasedate: 2023-06-30
:page-guide-category: microprofile
:page-essential: false
:page-description: Explore how to enable and customize tracing of REST service endpoint methods by using MicroProfile Telemetry and Jaeger tracing system.
:guide-author: Open Liberty
:page-tags: ['MicroProfile']
:page-permalink: /guides/{projectid}
:common-includes: https://raw.githubusercontent.com/OpenLiberty/guides-common/prod
:page-related-guides: [ 'cdi-intro' ]
:imagesdir: /img/guide/{projectid}
:page-seo-title: Enabling distributed tracing in Java microservices using MicroProfile Telemetry and the Jaeger distributed tracing system.
:page-seo-description: A getting started tutorial and an example on how to enable distributed tracing in Java microservices to easily trace request flows that span multiple resources by using MicroProfile Telemetry and Jaeger distributed tracing system.​
:source-highlighter: prettify
:guide-author: Open Liberty
= Enabling distributed tracing in microservices using OpenTelemetry observability framework 

[.hidden]
NOTE: This repository contains the guide documentation source. To view the guide in published form, view it on the https://openliberty.io/guides/{projectid}.html[Open Liberty website].

Distributed tracing helps DevOps teams to keep track of requests between microservices. MicroProfile Telemetry adopts OpenTelemetry tracing to allow developers to observe requests across their distributed systems.

// =================================================================================================
//  What you'll learn
// =================================================================================================

== What you'll learn
The use of microservices architecture may increase difficultly to see how services depend on or affect other services. Consequently, making it harder to find the source of latency or inaccuracy.

One way to increase observability of an application is by emitting traces. https://opentelemetry.io/[OpenTelemetry^] is a set of APIs, SDKs, tooling and integrations that are designed for the creation and management of telemetry data such as traces, metrics, and logs. MicroProfile Telemetry adopts OpenTelemetry so your applications can benefit from both manual and automatic traces.

Traces represent requests and consist of multiple spans. Spans are representative of single operations in a request and contain a name, time-related data, log messages and metadata to give information about what occurs during a transaction.

Context is an immutable object contained in the span data to identify the unique request that each span is a part of. This data is required for moving trace information across service boundaries, allowing developers to follow a single request through a potentially complex distributed system. Exporters are components that send data to a backend service so you can visualise and monitor the generated spans.

You'll configure the provided `inventory` and `system` services to use https://www.jaegertracing.io/[Jaeger] for distributed tracing with MicroProfile OpenTracing. You'll run these services in two separate JVMs made of two server instances to demonstrate tracing in a distributed environment. If all the components were run on a single server, then any logging software would be sufficient.

image::mptelemetry_diagram.png[Functionality Diagram,align="center"]


// =================================================================================================
//  Additional prerequisites 
// =================================================================================================

== Additional prerequisites 

Before you begin, deploy the Jaeger all-in-one executable file to start the Jaeger tracing system. The Jaeger all-in-one executable file is configured for quick local testing. You can find information about the Jaeger server and instructions for starting the all-in-one executable file in the https://www.jaegertracing.io/docs/latest/getting-started[Jaeger documentation].

Before you proceed, make sure that your Jaeger server is up and running. Jaeger can be found at the http://localhost:16686 URL.

// =================================================================================================
// Getting started
// =================================================================================================
[role='command']
include::{common-includes}/gitclone.adoc[]

=== Try what you'll build

// cloud-hosted guide instructions:
ifdef::cloud-hosted[]
Run the following docker command to start Jaeger server:
```bash
docker run -d --name jaeger \
  -e COLLECTOR_ZIPKIN_HTTP_PORT=9411 \
  -p 5775:5775/udp \
  -p 6831:6831/udp \
  -p 6832:6832/udp \
  -p 5778:5778 \
  -p 16686:16686 \
  -p 14268:14268 \
  -p 14250:14250 \
  -p 9411:9411 \
  jaegertracing/all-in-one:1.45
```

You can find information about the Jaeger server and instructions for starting the all-in-one executable file in the [Jaeger documentation](https://www.jaegertracing.io/docs/1.22/getting-started/#all-in-one).

Before you proceed, make sure that your Jaeger server is up and running. Click the following button to visit the Jaeger service:
::startApplication{port="16686" display="external" name="Visit Jaeger service" route="/"}
endif::[]

The `finish` directory in the root of this guide contains the finished application. Give it a try before you proceed.

ifndef::cloud-hosted[]
Open a command-line session and navigate to the `finish/system` directory. Run the following Maven goal to build the `system` service and deploy it to Open Liberty:

[role="command"]
----
mvn liberty:run
----

Open another command-line session and navigate to the `finish/inventory` directory. Run the following Maven goal to build the `inventory` service and deploy it to Open Liberty:

[role="command"]
----
mvn liberty:run
----
endif::[]


// cloud-hosted guide instructions:
ifdef::cloud-hosted[]
Navigate to the ***finish/system*** directory. Run the following Maven goal to build the ***system*** service and deploy it to Open Liberty:
```bash
cd /home/project/draft-guide-microprofile-telemetry-jaeger/finish/system
mvn liberty:run
```

Open another command-line session and navigate to the ***finish/inventory*** directory. Run the following Maven goal to build the ***inventory*** service and deploy it to Open Liberty:
```bash
cd /home/project/draft-guide-microprofile-telemetry-jaeger/finish/inventory
mvn liberty:run
```
endif::[]


After you see the following message in both command-line sessions, both of your services are ready:

[role="no_copy"]
----
The defaultServer server is ready to run a smarter planet.
----

Make sure that your Jaeger server is running and point your browser to the http://localhost:9081/inventory/systems/localhost URL. 

When you visit this endpoint, you make two GET HTTP requests, one to the system service and one to the inventory service. Both of these requests are configured to be traced, so a new trace is recorded in Jaeger.

To view the traces, go to the http://localhost:16686 URL. You can view the traces for the `inventory` or `system` services under the **Search** tab. If you only see the **jaeger-query** option listed in the dropdown, you need to wait a little longer and refresh the page to see the application services.

Select the services in the **Select A Service** menu and click the **Find Traces** button at the end of the section. You'll see the result as the following:

image::mptelemetry_result_items.png[Get traces by selecting result items,align="center"]


The trace has five spans, four from `inventory` service and one from `system` service. Click the trace to view its details. Under **Service & Operation**, you see the spans in this trace. You can inspect each span by clicking it to reveal more detailed information, such as the time at which a request was received and the time at which a response was sent back.

image::mptelemetry_inventory_manual_span.png[Inventory detail spans,align="center"]


After you’re finished reviewing the application, stop the Open Liberty servers by pressing `CTRL+C` in the command-line sessions where you ran the `system` and `inventory` services. Alternatively, you can run the following goals from the `finish` directory in another command-line session:

// static guide instructions:
ifndef::cloud-hosted[]
[role="command"]
----
 mvn -pl system liberty:stop
 mvn -pl inventory liberty:stop
----
endif::[]

// cloud-hosted guide instructions:
ifdef::cloud-hosted[]
```bash
cd /home/project/draft-guide-microprofile-telemetry-jaeger/finish
mvn -pl system liberty:stop
mvn -pl inventory liberty:stop
```
endif::[]

// =================================================================================================
// Building the application 
// =================================================================================================
== Building the application 

You need to start the services to see basic traces appear in Jaeger.

When you run Open Liberty in development mode, known as dev mode, the server listens for file changes and automatically recompiles and deploys your updates whenever you save a new change.

Open a command-line session and navigate to the `start/inventory` directory. Run the following Maven goal to start the `inventory` service in dev mode:

// static guide instructions:
ifndef::cloud-hosted[]
[role="command"]
----
mvn liberty:dev
----
endif::[]

// cloud-hosted guide instructions:
ifdef::cloud-hosted[]
```bash
cd /home/project/draft-guide-microprofile-telemetry-jaeger/start/inventory
mvn liberty:dev
```
endif::[]

Open a command-line session and navigate to the `start/system` directory. Run the following Maven goal to start the `system` service in dev mode:

// static guide instructions:
ifndef::cloud-hosted[]
[role="command"]
----
mvn liberty:dev
----
endif::[]

// cloud-hosted guide instructions:
ifdef::cloud-hosted[]
```bash
cd /home/project/draft-guide-microprofile-telemetry-jaeger/start/system
mvn liberty:dev
```
endif::[]

After you see the following message, your application server in dev mode is ready:

[role="no_copy"]
----
**************************************************************
*    Liberty is running in dev mode.
----

Dev mode holds your command-line session to listen for file changes. Open another command-line session to continue, or open the project in your editor.

When the servers start, you can find the system and inventory services at the following URLs:

* http://localhost:9080/system/properties
* http://localhost:9081/inventory/systems

// =================================================================================================
// Enabling the existing Telemetry implementation 
// =================================================================================================
== Enabling Telemetry implementation 

Navigate to the `start` directory to begin.

MicroProfile Telemetry allows you to observe traces without modifying source code in your Jakarta RESTful applications. You can enable `mpTelemetry` feature in the `server.xml` configuration file.

[role="code_command hotspot file=0", subs="quotes"]
----
#Replace the `server.xml` file of the system service.#
`system/src/main/liberty/config/server.xml`
----

system/server.xml
[source, xml, linenums, role='code_column']
----
include::finish/system/src/main/liberty/config/server.xml[]
----

Enable [hotspot=mpTelemetry file=0]`mpTelemetry` feature in the `server.xml` of the `system` service.

[role="code_command hotspot file=1", subs="quotes"]
----
#Replace the `server.xml` file of the inventory service.#
`inventory/src/main/liberty/config/server.xml`
----

inventory/server.xml
[source, xml, linenums, role='code_column hide_tags=thirdParty']
----
include::finish/inventory/src/main/liberty/config/server.xml[]
----

Enable [hotspot=mpTelemetry file=1]`mpTelemetry` feature in the `server.xml` of the `inventory` service.


By default, MicroProfile Telemetry tracing is off. To enable any tracing aspects, specify the `otel` properties in the MicroProfile configuration file. 

[role="code_command hotspot file=2", subs="quotes"]
----
#Create the `microprofile-config.properties` file  of the system service.#
`system/src/main/resources/META-INF/microprofile-config.properties`
----

system/microprofile-config.properties
[source, Text, linenums, role='code_column']
----
include::finish/system/src/main/resources/META-INF/microprofile-config.properties[]
----

Specify the [hotspot=service file=2]`otel.service.name` property with the `system` service name, set the [hotspot=disabled file=2]`otel.sdk.disabled` property with `false` to enable tracing, and specify the [hotspot=exporter file=2]`otel.traces.exporter` property with `jaeger` for using Jaeger tracing system.


[role="code_command hotspot file=3", subs="quotes"]
----
#Create the `microprofile-config.properties` file of the inventory service.#
`inventory/src/main/resources/META-INF/microprofile-config.properties`
----

inventory/microprofile-config.properties
[source, Text, linenums, role='code_column']
----
include::finish/inventory/src/main/resources/META-INF/microprofile-config.properties[]
----

Simiarly, specify the [hotspot=otel file=3]`otel` properties for the `inventory` service.

For more information about these and other Telemetry properties, see the https://openliberty.io/docs/latest/microprofile-config-properties.html#telemetry[MicroProfile Config properties for MicroProfile Telemetry^] documentation.

To run the `system` and `inventory` services, simply navigate your browser to the http://localhost:9081/inventory/systems/localhost URL.

To view the traces, go to the http://localhost:16686 URL. You can view the traces for the `inventory` or `system` services under the **Search** tab. Select the services in the **Select A Service** menu and click the **Find Traces** button at the end of the section. You'll see the result as the following:

image::mptelemetry_default_spans.png[Default spans,align="center"]


Verify that there are two spans from `inventory` service and one span from `system` service. Click the trace to view its details.

image::mptelemetry_detail_default_spans.png[Detail default spans,align="center"]

// =================================================================================================
// Enabling explicit distributed tracing
// =================================================================================================
== Enabling explicit distributed tracing

Automatic instrumentation only instruments Jakarta RESTful web services and MicroProfile REST clients. To get further spans on other operations, such as database calls, you can add manual instrumentation to the source code.

=== Enabling OpenTelemetry APIs

// The MicroProfile Telemetry feature has been enabled tracing of all REST endpoints by default in the previous section. To further control and customize traces, use the `@WithSpan` annotation to enable particular methods. You can also inject a custom `Tracer` object to create and customize spans.
The MicroProfile Telemetry feature has been enabled tracing of all REST endpoints by default in the previous section. To further control and customize traces, you inject a custom `Tracer` object to create and customize spans.

[role="code_command hotspot file=0", subs="quotes"]
----
#Replace the `pom.xml` Maven project file of the inventory service.#
`inventory/pom.xml`
----

pom.xml
[source, xml, linenums, role='code_column']
----
include::finish/inventory/pom.xml[]
----

The OpenTelemetry API and OpenTelemetry Instrumentation Annotations must be provided as dependencies to your build path. Add two [hotspot=opentelemetry file=0]`io.opentelemetry` dependencies in your `pom.xml` Maven project file.

[role="code_command hotspot file=1", subs="quotes"]
----
#Replace the `server.xml` file of the inventory service.#
`inventory/src/main/liberty/config/server.xml`
----

inventory/server.xml
[source, xml, linenums, role='code_column']
----
include::finish/inventory/src/main/liberty/config/server.xml[]
----

The OpenTelemetry APIs are exposed as third-party APIs in Open Liberty. To add the visibility of OpenTelemetry APIs to the application, add `third-party` to the types of API packages that this class loader supports. Instead of explicitly configuring a list of API packages that includes `third-party`, set the `+third-party` value to the [hotspot=thirdParty file=1]`apiTypeVisibility` attribute in the [hotspot=thirdParty file=1]`classLoader` configuration. This configuration adds `third-party` to the default list of API package types that are supported.



=== Injecting a custom Tracer object

//You can create new spans by annotating methods with a `@WithSpan` annotation.

//[role="code_command hotspot file=0", subs="quotes"]
//----
//#Replace the `InventoryManager` class.#
//`inventory/src/main/java/io/openliberty/guides/inventory/InventoryManager.java`
//----

//InventoryManager.java
//[source, java, linenums, role='code_column hide_tags=copyright']
//----
//include::finish/inventory/src/main/java/io/openliberty/guides/inventory/InventoryManager.java[]
//----

//Annotate the `add()` method with the [hotspot=addWithSpan file=0]`@WithSpan` annotation and the `hostname` parameter with the [hotspot=spanAttribute file=0]`@SpanAttribute` annotation to indicate that it is part of the trace.

//To customize a span name, you can annotate the `list()` method by the [hotspot=listWithSpan file=0]`@WithSpan` annotation with a value.


The MicroProfile Telemetry specification makes the underlying OpenTelemetry Tracer instance available. The configured Tracer is accessed by injecting it into a bean. You can use it to instrument your code to create traces.

// TO DO - when resume the WithSpan portion, change the following file number from 0 to 1
[role="code_command hotspot file=0", subs="quotes"]
----
#Replace the `InventoryResource` class.#
`inventory/src/main/java/io/openliberty/guides/inventory/InventoryResource.java`
----

InventoryResource.java
[source, java, linenums, role='code_column hide_tags=copyright']
----
include::finish/inventory/src/main/java/io/openliberty/guides/inventory/InventoryResource.java[]
----

To access the Tracer, inject it into a bean by using the [hotspot=inject file=0]`@Inject` annotation from the Contexts and Dependency Injections API.

Before the [hotspot=manager hotspot=getSystem file=0]`InventoryManager` to call the `system` service, create and start a span called [hotspot=getPropertiesSpan file=0]`GettingProperties` by using the `spanBuilder()` and `startSpan()` Tracer APIs.

The [hotspot=try file=0]`try` block is called a `try-with-resources` statement that the `scope` object is closed at the end of the statement. It’s good practice to define custom spans inside such statements. Otherwise, any exceptions that are thrown before the span closes will leak the active span.

Use the [hotspot=addEvent1 hotspot=addEvent2 file=0]`addEvent()` Span API to create an event when the properties are received and an event when fails to get the properties from the [hotspot=manager hotspot=getSystem file=0]`system` service. Use the [hotspot=end file=0]`end()` Span API to mark the `GettingProperties` span completed.


Navigate your browser to the http://localhost:9081/inventory/systems/localhost URL.

Check your Jaeger server at the http://localhost:16686 URL. Select the `inventory` service and click the **Find Traces** button at the end of the section. You'll see the result as the following:

image::mptelemetry_result_items.png[Get inventory traces,align="center"]


Verify that there are four spans from `inventory` service and one span from `system` service. Click the trace to view its details.

image::mptelemetry_inventory_manual_span.png[Inventory detail spans,align="center"]


//Navigate your browser to the http://localhost:9081/inventory/systems URL.

//Check your Jaeger server at the http://localhost:16686 URL. Select the `inventory` service and click the **Find Traces** button at the end of the section. You'll see the result as the following:

//image::mptelemetry_inventory_manager_span.png[Inventory list span,align="center"]


//Verify that there a span from the `inventory` service. Click the trace to view its details.
//image::mptelemetry_inventory_manager_span.png[Inventory list span,align="center"]


To learn more how to use OpenTelemetry APIs to instrument code, see the https://opentelemetry.io/docs/instrumentation/java/manual/[OpenTelemetry Manual Instrumentation] documentation.

// =================================================================================================
// Testing the application 
// =================================================================================================
== Testing the application 

No automated tests are provided to verify the correctness of the traces. Manually verify these traces by viewing them on the Jaeger server.

A few tests are included for you to test the basic functionality of the services. If a test failure occurs, then you might have introduced a bug into the code.

=== Running the tests

Since you started Open Liberty in dev mode, run the tests for the system and inventory services by pressing the `enter/return` key in the command-line sessions where you started the services.

When you are done checking out the services, exit dev mode by pressing `CTRL+C` in the shell sessions where you ran the system and inventory services, or by typing `q` and then pressing the `enter/return` key.

// static guide instructions:
ifndef::cloud-hosted[]
Finally, stop the `Jaeger` service that you started in the **Additional prerequisites** section.
endif::[]

// cloud-hosted guide instructions:
ifdef::cloud-hosted[]
Finally, stop the ***Jaeger*** service that you started in the previous step.
```bash
docker stop jaeger
docker rm jaeger
```
endif::[]

// =================================================================================================
// Great work! You're done!
// =================================================================================================

== Great work! You're done!

You just used MicroProfile Telemetry in Open Liberty to customize how and which traces are delivered to Jaeger.

Try out one of the related MicroProfile guides. These guides demonstrate more technologies that you can learn to expand on what you built in this guide.

include::{common-includes}/attribution.adoc[subs="attributes"]
